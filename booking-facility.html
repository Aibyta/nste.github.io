<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Book a Court | NSTE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #f0f4f8;
        }

        .facility-card {
            border: none;
            transition: transform 0.3s ease;
        }

        .facility-card:hover {
            transform: scale(1.03);
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .date-carousel {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 1rem 0;
        }

        .date-box {
            min-width: 90px;
            text-align: center;
            border-radius: 8px;
            padding: 0.8rem 0.4rem;
            background: #fff;
            border: 2px solid #007bff;
            cursor: pointer;
            transition: 0.3s;
            user-select: none;
            position: relative;
        }

        .date-box:hover:not(.disabled),
        .date-box.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .date-box.disabled {
            cursor: not-allowed;
            background-color: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        .date-box .count {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .time-slot {
            border: 2px solid #007bff;
            border-radius: 25px;
            padding: 0.4rem 1rem;
            margin: 0.4rem;
            cursor: pointer;
            transition: background 0.3s;
            user-select: none;
            min-width: 90px;
            text-align: center;
            font-weight: 500;
            position: relative;
            color: #007bff;
            background: rgb(46, 247, 28);
        }

        .time-slot.active {
            background-color: #007bff;
            color: rgb(46, 247, 28);
            font-weight: 700;
        }

        .time-slot.disabled {
            cursor: not-allowed;
            background-color: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        .time-slot.warning {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: black !important;
        }

        .time-slot .blocked-icon {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 18px;
        }

        #loadingDates,
        #loadingSlots {
            display: none;
            text-align: center;
            margin: 1rem 0;
            color: #007bff;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">üéü Book Your Court Easily</h2>

        <!-- Court Poster Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card facility-card" data-facility="Basketball Court">
                    <img src="img/basketball.jpg" class="card-img-top" alt="Basketball" />
                    <div class="card-body text-center">
                        <h5>üèÄ Basketball Court</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card facility-card" data-facility="Tennis Court">
                    <img src="img/tennis.jpg" class="card-img-top" alt="Tennis" />
                    <div class="card-body text-center">
                        <h5>üéæ Tennis Court</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card facility-card" data-facility="Badminton Court">
                    <img src="img/badminton.jpg" class="card-img-top" alt="Badminton" />
                    <div class="card-body text-center">
                        <h5>üè∏ Badminton Court</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking UI -->
        <div id="bookingSection" style="display:none;">
            <h4 class="text-center mb-3">üìÖ Choose a Date</h4>
            <div id="loadingDates">Loading dates...</div>
            <div class="date-carousel" id="dateCarousel"></div>

            <h4 class="text-center mt-4 mb-3" id="timeSlotHeader" style="display:none;">‚è∞ Select Time Slot</h4>
            <div id="loadingSlots">Loading time slots...</div>
            <div class="d-flex justify-content-center flex-wrap" id="timeSlots" style="display:none;"></div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" id="bookNowBtn">‚úÖ Confirm Booking</button>
            </div>
            <div class="text-center mt-3" id="bookingMessage"></div>
        </div>
    </div>

    <!-- Firebase & Script -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
            authDomain: "nste-booking-system.firebaseapp.com",
            projectId: "nste-booking-system",
            storageBucket: "nste-booking-system.appspot.com",
            messagingSenderId: "574207536433",
            appId: "1:574207536433:web:0d2aeaacdc280cec019410"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const facilityCards = document.querySelectorAll('.facility-card');
        const bookingSection = document.getElementById('bookingSection');
        const dateCarousel = document.getElementById('dateCarousel');
        const timeSlots = document.getElementById('timeSlots');
        const bookingMessage = document.getElementById('bookingMessage');
        const timeSlotHeader = document.getElementById('timeSlotHeader');
        const loadingDates = document.getElementById('loadingDates');
        const loadingSlots = document.getElementById('loadingSlots');
        const bookNowBtn = document.getElementById('bookNowBtn');

        const timeSlotOptions = ["08:00-09:00", "09:00-10:00", "16:00-17:00", "17:00-18:00"];

        const SLOT_THRESHOLD = 3; // max allowed bookings per slot
        const DATE_THRESHOLD = 8; // max allowed bookings per date

        let selectedFacility = null;
        let selectedDate = null;
        let selectedTime = null;
        let unsubscribeSlots = null;
        let bookingsData = []; // cached bookings for date threshold

        facilityCards.forEach(card => {
            card.addEventListener('click', () => {
                selectedFacility = card.getAttribute("data-facility");
                facilityCards.forEach(c => c.classList.remove("border-primary"));
                card.classList.add("border", "border-primary");
                bookingSection.style.display = "block";
                selectedDate = null;
                selectedTime = null;
                bookingMessage.innerHTML = "";

                // Reset time slot UI
                timeSlotHeader.style.display = "none";
                timeSlots.style.display = "none";
                timeSlots.innerHTML = "";

                renderDates();
            });
        });

        function renderDates() {
            dateCarousel.innerHTML = "";
            loadingDates.style.display = "block";

            const today = new Date();
            const datesToRender = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                datesToRender.push({ date: d, dateStr });
            }

            db.collection("bookings")
                .where("facility", "==", selectedFacility)
                .where("status", "in", ["approved", "pending"])
                .get()
                .then(snapshot => {
                    bookingsData = snapshot.docs.map(doc => doc.data());
                    loadingDates.style.display = "none";

                    datesToRender.forEach(({ date, dateStr }) => {
                        const box = document.createElement("div");
                        box.className = "date-box";
                        box.innerHTML = `<strong>${date.toDateString().slice(0, 3)}</strong><br/><span>${date.getDate()}/${date.getMonth() + 1}</span>`;

                        // Count bookings for this date
                        const countForDate = bookingsData.filter(b => b.date === dateStr).length;

                        const countSpan = document.createElement("div");
                        countSpan.className = "count";
                        countSpan.innerText = `${countForDate} booked`;
                        box.appendChild(countSpan);

                        // Color by threshold
                        if (countForDate >= DATE_THRESHOLD) {
                            box.classList.add("disabled");
                            box.title = `Fully booked (${countForDate} bookings)`;
                        } else if (countForDate >= Math.floor(DATE_THRESHOLD / 2)) {
                            box.style.backgroundColor = "#ffc107";
                            box.style.borderColor = "#ffc107";
                            box.title = `${countForDate} bookings (approaching full)`;
                        }

                        box.dataset.date = dateStr;

                        box.addEventListener('click', () => {
                            if (box.classList.contains('disabled')) return;

                            selectedDate = dateStr;
                            selectedTime = null;

                            document.querySelectorAll('.date-box').forEach(b => b.classList.remove('active'));
                            box.classList.add('active');

                            // Show time slots UI now
                            timeSlotHeader.style.display = "block";
                            timeSlots.style.display = "flex";
                            bookingMessage.innerHTML = "";

                            renderTimeSlots();
                        });
                        dateCarousel.appendChild(box);
                    });
                })
                .catch(error => {
                    loadingDates.style.display = "none";
                    bookingMessage.innerHTML = `<div class="alert alert-danger">Error loading dates: ${error.message}</div>`;
                });
        }

        function renderTimeSlots() {
            timeSlots.innerHTML = "";
            loadingSlots.style.display = "block";

            if (unsubscribeSlots) unsubscribeSlots();

            // Initially create all time slots with green border
            timeSlotOptions.forEach(time => {
                const btn = document.createElement("div");
                btn.className = "time-slot";
                btn.innerText = time;
                btn.dataset.time = time;
                timeSlots.appendChild(btn);

                btn.addEventListener("click", () => {
                    if (btn.classList.contains("disabled")) return;
                    selectedTime = time;
                    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            unsubscribeSlots = db.collection("bookings")
                .where("facility", "==", selectedFacility)
                .where("date", "==", selectedDate)
                .where("status", "in", ["approved", "pending"])
                .onSnapshot(snapshot => {
                    loadingSlots.style.display = "none";

                    // Reset slots to default style
                    document.querySelectorAll('.time-slot').forEach(slot => {
                        slot.classList.remove("disabled", "warning", "active");
                        slot.style.backgroundColor = "light green";
                        slot.style.color = "white";
                        slot.style.borderColor = "#007bff";
                        const icon = slot.querySelector(".blocked-icon");
                        if (icon) icon.remove();
                    });

                    // Count bookings per slot
                    const slotCounts = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        slotCounts[data.time] = (slotCounts[data.time] || 0) + 1;
                    });

                    for (const [time, count] of Object.entries(slotCounts)) {
                        const btn = document.querySelector(`.time-slot[data-time="${time}"]`);
                        if (!btn) continue;

                        if (count >= SLOT_THRESHOLD) {
                            btn.classList.add("disabled");
                            btn.style.backgroundColor = "#dc3545";
                            btn.style.borderColor = "#dc3545";
                            btn.style.color = "white";
                            btn.title = `Fully booked (${count} bookings)`;

                            // Add blocked icon
                            const icon = document.createElement("span");
                            icon.className = "blocked-icon";
                            icon.textContent = "‚ùå";
                            btn.appendChild(icon);

                            // If this slot was selected, deselect
                            if (btn.classList.contains('active')) {
                                btn.classList.remove('active');
                                selectedTime = null;
                            }
                        } else if (count >= Math.floor(SLOT_THRESHOLD / 2)) {
                            btn.classList.add("warning");
                            btn.title = `${count} bookings (approaching full)`;
                        }
                    }
                }, error => {
                    loadingSlots.style.display = "none";
                    bookingMessage.innerHTML = `<div class="alert alert-danger">Error loading time slots: ${error.message}</div>`;
                });
        }

        bookNowBtn.addEventListener('click', () => {
            bookingMessage.innerHTML = "";

            if (!selectedFacility) {
                bookingMessage.innerHTML = `<div class="alert alert-warning">Please select a facility first.</div>`;
                return;
            }
            if (!selectedDate) {
                bookingMessage.innerHTML = `<div class="alert alert-warning">Please select a date.</div>`;
                return;
            }
            if (!selectedTime) {
                bookingMessage.innerHTML = `<div class="alert alert-warning">Please select a time slot.</div>`;
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                bookingMessage.innerHTML = `<div class="alert alert-warning">Please log in to book.</div>`;
                return;
            }

            // Check if slot still available
            db.collection("bookings")
                .where("facility", "==", selectedFacility)
                .where("date", "==", selectedDate)
                .where("time", "==", selectedTime)
                .where("status", "in", ["approved", "pending"])
                .get()
                .then(snapshot => {
                    if (snapshot.size >= SLOT_THRESHOLD) {
                        bookingMessage.innerHTML = `<div class="alert alert-danger">Sorry, this time slot is fully booked now. Please select another.</div>`;
                        return;
                    }

                    // Create booking with status pending
                    db.collection("bookings").add({
                        facility: selectedFacility,
                        date: selectedDate,
                        time: selectedTime,
                        status: "pending",
                        userId: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        bookingMessage.innerHTML = `<div class="alert alert-success">Booking request sent! Await admin approval.</div>`;

                        // Reset selections but keep facility
                        selectedDate = null;
                        selectedTime = null;
                        timeSlotHeader.style.display = "none";
                        timeSlots.style.display = "none";
                        timeSlots.innerHTML = "";

                        // Refresh dates to update booking counts
                        renderDates();
                    }).catch(err => {
                        bookingMessage.innerHTML = `<div class="alert alert-danger">Error booking: ${err.message}</div>`;
                    });
                })
                .catch(err => {
                    bookingMessage.innerHTML = `<div class="alert alert-danger">Error checking slot availability: ${err.message}</div>`;
                });
        });

        // Optional: Auto sign-in anonymously for testing
        auth.signInAnonymously().catch(console.error);
    </script>
</body>

</html>
