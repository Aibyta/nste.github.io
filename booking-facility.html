<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Tennis Court | NSTE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/evo-calendar@1.1.3/evo-calendar/css/evo-calendar.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: #f8f9fa; 
    }
    .facility-card { 
      transition: transform 0.2s; 
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .facility-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .court-image { 
      height: 200px; 
      object-fit: cover; 
    }
    .friend-badge {
      background-color: #e3f2fd;
      color: #0d6efd;
      display: inline-flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .loading-spinner {
      width: 3rem;
      height: 3rem;
      margin: 2rem auto;
      display: block;
    }
    .slot-btn {
      width: 120px;
      margin: 5px;
    }
    #bookingDetails {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    .modal-header {
      border-bottom: none;
    }
    .modal-footer {
      border-top: none;
    }
    .theme-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    .promo-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
    }
    .search-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom: 3px solid #0d6efd;
    }
    .event-card {
      transition: all 0.3s;
      cursor: pointer;
    }
    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .skill-level {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .skill-beginner {
      background-color: #d4edda;
      color: #155724;
    }
    .skill-intermediate {
      background-color: #fff3cd;
      color: #856404;
    }
    .skill-advanced {
      background-color: #f8d7da;
      color: #721c24;
    }
    .select2-container--default .select2-selection--multiple {
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      min-height: 38px;
    }
    .event-image {
      height: 150px;
      object-fit: cover;
    }
    .compatibility-meter {
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
    }
    .compatibility-fill {
      height: 100%;
      background-color: #28a745;
      border-radius: 5px;
    }
    .match-card {
      border-left: 4px solid #0d6efd;
    }
  </style>
</head>
<body>
  <button class="btn btn-outline-secondary theme-btn" id="toggleTheme">🌙</button>

  <div class="container py-4">
    <div id="friendNotice" class="alert alert-info d-none">
      <i class="bi bi-info-circle"></i> You're booking with: <strong id="friendName"></strong>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- Search and Filter Section -->
    <div class="search-container mb-4">
      <ul class="nav nav-tabs mb-3" id="bookingTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="facility-tab" data-bs-toggle="tab" data-bs-target="#facility-tab-pane" type="button">Book Facility</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="event-tab" data-bs-toggle="tab" data-bs-target="#event-tab-pane" type="button">Create Event</button>
        </li>
      </ul>
      
      <div class="tab-content" id="bookingTabsContent">
        <!-- Facility Booking Tab -->
        <div class="tab-pane fade show active" id="facility-tab-pane" role="tabpanel">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="sportType" class="form-label">Sport Type</label>
              <select class="form-select" id="sportType">
                <option value="tennis" selected>Tennis</option>
                <option value="badminton">Badminton</option>
                <option value="squash">Squash</option>
                <option value="basketball">Basketball</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="locationSearch" class="form-label">Location</label>
              <select class="form-select" id="locationSearch">
                <option value="" selected>All Areas</option>
                <option value="kuala lumpur">Kuala Lumpur</option>
                <option value="petaling jaya">Petaling Jaya</option>
                <option value="subang jaya">Subang Jaya</option>
                <option value="puchong">Puchong</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="facilityNameSearch" class="form-label">Facility Name</label>
              <input type="text" class="form-control" id="facilityNameSearch" placeholder="Search by name">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" id="searchBtn">
                <i class="bi bi-search"></i> Search
              </button>
            </div>
          </div>
        </div>
        
        <!-- Event Creation Tab -->
        <div class="tab-pane fade" id="event-tab-pane" role="tabpanel">
          <form id="eventForm">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="eventSportType" class="form-label">Sport Type*</label>
                <select class="form-select" id="eventSportType" required>
                  <option value="" disabled selected>Select sport</option>
                  <option value="tennis">Tennis</option>
                  <option value="badminton">Badminton</option>
                  <option value="squash">Squash</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="eventDate" class="form-label">Date*</label>
                <input type="date" class="form-control" id="eventDate" required>
              </div>
              <div class="col-md-3">
                <label for="eventTime" class="form-label">Time*</label>
                <input type="time" class="form-control" id="eventTime" required>
              </div>
              <div class="col-md-3">
                <label for="eventDuration" class="form-label">Duration*</label>
                <select class="form-select" id="eventDuration" required>
                  <option value="1">1 hour</option>
                  <option value="1.5">1.5 hours</option>
                  <option value="2" selected>2 hours</option>
                  <option value="3">3 hours</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="eventSkillLevel" class="form-label">Skill Level*</label>
                <select class="form-select" id="eventSkillLevel" required>
                  <option value="beginner">Beginner</option>
                  <option value="intermediate" selected>Intermediate</option>
                  <option value="advanced">Advanced</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="eventPlayersNeeded" class="form-label">Players Needed*</label>
                <select class="form-select" id="eventPlayersNeeded" required>
                  <option value="1">1 player</option>
                  <option value="2" selected>2 players</option>
                  <option value="4">4 players (doubles)</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="eventFacility" class="form-label">Facility</label>
                  <textarea class="form-control" id="eventFacility" rows="1" placeholder="Enter facility name..."></textarea>
              </div>
              <div class="col-12">
                <label for="eventDescription" class="form-label">Event Description</label>
                <textarea class="form-control" id="eventDescription" rows="2" placeholder="Describe your event..."></textarea>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-success" id="createEventBtn">
                  <i class="bi bi-calendar-event"></i> Create Event
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <h1 class="text-center mb-4" id="pageTitle">Book a Tennis Court</h1>
    
    <div id="facilityList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
    
    <div id="calendarSection" style="display: none;">
      <button class="btn btn-outline-secondary mb-3" id="backToFacilitiesBtn">
        <i class="bi bi-arrow-left"></i> Back to Courts
      </button>
      <h3 class="mb-3">Select Date for <span id="facilityNameDisplay"></span></h3>
      <div id="promoDetails" class="alert alert-info mb-3 d-none"></div>
      <div id="evoCalendar"></div>
    </div>
    
    <!-- Events Section -->
    <div id="eventsSection" class="mt-5" style="display: none;">
      <h2 class="mb-4">Upcoming Tennis Events</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="eventsList"></div>
    </div>
  </div>

  <!-- Slot Selection Modal -->
  <div class="modal fade" id="slotModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Book <span id="selectedFacilityText"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 class="mb-3">Date: <span id="selectedDateText"></span></h6>
          <div id="slotButtons" class="d-flex flex-wrap justify-content-center"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Snacks Selection Modal -->
  <div class="modal fade" id="snacksModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Add Snacks to Your Booking</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row row-cols-1 row-cols-md-2 g-3" id="snacksList"></div>
          <div class="mt-4">
            <h5>Your Selections</h5>
            <div id="selectedSnacks"></div>
            <div class="d-flex justify-content-between mt-3">
              <h6>Total: RM<span id="snacksTotal">0</span></h6>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="skipSnacksBtn">Skip Snacks</button>
          <button class="btn btn-primary" id="proceedToCoachBtn">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Coach Selection Modal -->
  <div class="modal fade" id="coachModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Add a Coach to Your Session</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="coachOption" id="noCoach" value="no" checked>
            <label class="form-check-label" for="noCoach">
              No coach needed
            </label>
          </div>
          <div class="row row-cols-1 g-3" id="coachesList"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>
          <button class="btn btn-success" id="confirmBookingBtn">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-check-circle"></i> Booking Confirmed</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Your tennis court booking has been confirmed!</p>
          <div id="bookingDetails" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Confirmation Modal -->
  <div class="modal fade" id="eventConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-check-circle"></i> Event Created</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Your event has been created and notifications have been sent to matching players!</p>
          <div id="eventDetails" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Match Details Modal -->
  <div class="modal fade" id="matchDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">AI Match Results</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="matchResultsContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading" class="text-center my-5">
    <div class="spinner-border text-primary loading-spinner" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading courts...</p>
  </div>

  <!-- Firebase and other scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/evo-calendar@1.1.3/evo-calendar/js/evo-calendar.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
      messagingSenderId: "574207536433",
      appId: "1:574207536433:web:0d2aeaacdc280cec019410"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let selectedFacility = null;
    let selectedDate = null;
    let selectedSlot = null;
    let selectedSnacks = [];
    let selectedCoach = null;
    let currentTheme = 'Royal Navy';
    let bookingWithFriend = null;
    let currentSport = 'tennis';
    let facilitiesData = [];
    let eventsData = [];

    // Sample data for snacks and coaches
    const snacksData = [
      { id: 1, name: "Energy Bar", price: 5, image: "https://cdn.mos.cms.futurecdn.net/CpcooP3z8M7QXfQ6Gfncdg.jpg" },
      { id: 2, name: "Sports Drink", price: 8, image: "https://premierfootballuk.com/wp-content/uploads/Sports-drink.jpg" },
      { id: 3, name: "Protein Shake", price: 12, image: "https://i5.walmartimages.com/asr/949c9c39-f0fb-4d3e-80e2-484dad00b8ec.41c3cb759a9ad3cdedabe2cf25cafd45.jpeg" },
      { id: 4, name: "Banana", price: 2, image: "https://wallpaperaccess.com/full/889245.jpg" }
    ];

    const coachesData = [
      { id: 1, name: "Coach Alex", price: 50, image: "https://cdn.sanity.io/images/1oknuwv8/production/cc88b7a952bbddfd5828b6dc28deee2619bcab75-2000x1334.webp?rect=0,138,2000,1058&w=1200&h=635&fit=crop&auto=format", experience: "5 years", rating: 4.8 },
      { id: 2, name: "Coach Maria", price: 60, image: "https://dbukjj6eu5tsf.cloudfront.net/sidearm.sites/csufullerton.sidearmsports.com/images/2025/1/13/Ellie_Johnson_HS.jpg?width=300", experience: "7 years", rating: 4.9 },
      { id: 3, name: "Coach Sam", price: 45, image: "https://fitintennis.com/wp-content/uploads/2020/04/Javier-professional-tennis-coach-in-Barcelona.jpg", experience: "3 years", rating: 4.5 }
    ];

    // Sample events data
    const sampleEvents = [
      {
        id: 1,
        title: "Weekend Tennis Tournament",
        sport: "tennis",
        date: "2023-12-02",
        time: "14:00",
        duration: 3,
        facility: "KL Sports Center",
        skillLevel: "intermediate",
        playersNeeded: 4,
        description: "Friendly doubles tournament for intermediate players",
        organizer: "Alex Tan",
        image: "https://images.unsplash.com/photo-1574629810360-7efbbe195018?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80"
      },
      {
        id: 2,
        title: "Beginner Tennis Clinic",
        sport: "tennis",
        date: "2023-12-05",
        time: "18:00",
        duration: 2,
        facility: "PJ Tennis Club",
        skillLevel: "beginner",
        playersNeeded: 2,
        description: "Learn basic tennis techniques with our coach",
        organizer: "Maria Lim",
        image: "https://images.unsplash.com/photo-1547347298-4074fc3086f0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80"
      },
      {
        id: 3,
        title: "Advanced Tennis Training",
        sport: "tennis",
        date: "2023-12-08",
        time: "19:00",
        duration: 2,
        facility: "KL Sports Center",
        skillLevel: "advanced",
        playersNeeded: 1,
        description: "Intensive training session for advanced players",
        organizer: "Coach Sam",
        image: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80"
      }
    ];

    $(document).ready(function() {
      // Initialize Select2 for multiple select
      $('#inviteFriends').select2();
      
      // Check if booking with a friend
      const friendData = sessionStorage.getItem('bookingWithFriend');
      if (friendData) {
        bookingWithFriend = JSON.parse(friendData);
        document.getElementById('friendNotice').classList.remove('d-none');
        document.getElementById('friendName').textContent = bookingWithFriend.name;
        sessionStorage.removeItem('bookingWithFriend');
      }

      // Initialize calendar
      $('#evoCalendar').evoCalendar({
        theme: currentTheme,
        sidebarDisplayDefault: false,
        sidebarToggler: false,
        eventDisplayDefault: false,
        eventListToggler: false
      });

      // Theme toggle button
      $('#toggleTheme').click(() => {
        currentTheme = currentTheme === 'Royal Navy' ? 'Midnight Blue' : 'Royal Navy';
        $('#toggleTheme').text(currentTheme === 'Royal Navy' ? '🌙' : '☀️');
        $('#evoCalendar').evoCalendar('setTheme', currentTheme);
      });

      // Auth state listener
      auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
          loadFacilities();
          loadEvents();
          loadFacilitiesForDropdown();
        } else {
          $('#facilityList').html('<div class="alert alert-warning">Please log in to book courts</div>');
          $('#loading').hide();
        }
      });

      // Back to facilities button
      $('#backToFacilitiesBtn').click(() => {
        $('#calendarSection').hide();
        $('#facilityList').show();
        $('#eventsSection').hide();
      });

      // Date selection handler
      $('#evoCalendar').on('selectDate', (_, newDate) => {
        selectedDate = newDate;
        loadBookingsForFacility();
      });

      // Skip snacks button
      $('#skipSnacksBtn').click(() => {
        selectedSnacks = [];
        $('#snacksModal').modal('hide');
        showCoachesSelection();
      });

      // Proceed to coaches button
      $('#proceedToCoachBtn').click(() => {
        $('#snacksModal').modal('hide');
        showCoachesSelection();
      });

      // Confirm booking button
      $('#confirmBookingBtn').click(() => {
        const coachOption = $('input[name="coachOption"]:checked').val();
        selectedCoach = coachOption === 'no' ? null : 
          coachesData.find(c => c.id == coachOption);
        completeBooking();
      });

      // Search button click
      $('#searchBtn').click(() => {
        currentSport = $('#sportType').val();
        $('#pageTitle').text(`Book a ${capitalizeFirstLetter(currentSport)} Court`);
        loadFacilities();
      });

      // Sport type change
      $('#sportType').change(() => {
        currentSport = $('#sportType').val();
        $('#pageTitle').text(`Book a ${capitalizeFirstLetter(currentSport)} Court`);
      });

      // Private event checkbox
      $('#eventPrivate').change(function() {
        if ($(this).is(':checked')) {
          $('#inviteFriendsContainer').show();
        } else {
          $('#inviteFriendsContainer').hide();
        }
      });

      // Event form submission
      $('#eventForm').submit(function(e) {
        e.preventDefault();
        createEvent();
      });

      // Tab change handler
      $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
        if (e.target.id === 'event-tab') {
          $('#facilityList').hide();
          $('#calendarSection').hide();
          $('#eventsSection').hide();
        } else {
          $('#facilityList').show();
          $('#calendarSection').hide();
          $('#eventsSection').hide();
        }
      });

      // Set minimum date for event date picker to today
      const today = new Date().toISOString().split('T')[0];
      $('#eventDate').attr('min', today);
    });

    // Load facilities for dropdown in event form
    async function loadFacilitiesForDropdown() {
      try {
        const snapshot = await db.collection('facilities')
          .where('type', '==', $('#eventSportType').val())
          .get();
        
        $('#eventFacility').empty();
        $('#eventFacility').append('<option value="" selected>Any facility</option>');
        
        snapshot.forEach(doc => {
          const facility = doc.data();
          $('#eventFacility').append(`<option value="${doc.id}">${facility.name}</option>`);
        });
        
      } catch (error) {
        console.error("Error loading facilities:", error);
        $('#eventFacility').html('<option value="" selected>Error loading facilities</option>');
      }
    }

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function getSkillLevelClass(level) {
      switch(level) {
        case 'beginner': return 'skill-beginner';
        case 'intermediate': return 'skill-intermediate';
        case 'advanced': return 'skill-advanced';
        default: return '';
      }
    }

    function formatTime(timeString) {
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${minutes} ${ampm}`;
    }

    // AI Matching Algorithm
    function findMatchingPlayers(eventData) {
      return new Promise(async (resolve) => {
        try {
          // Get all users with matching skill level
          const usersSnapshot = await db.collection('users')
            .where('skillLevel', '==', eventData.skillLevel)
            .get();
          
          const potentialMatches = [];
          
          usersSnapshot.forEach(doc => {
            const user = doc.data();
            // Basic matching criteria (can be enhanced)
            if (user.uid !== currentUser.uid && // Don't match with self
                user.preferredTimes.some(time => 
                  eventData.time.includes("Evening") ? 
                  time.includes("Evening") : 
                  time.includes("Morning"))) {
              
              // Calculate compatibility score
              const compatibilityScore = calculateCompatibility(user, eventData);
              
              potentialMatches.push({
                ...user,
                compatibilityScore,
                id: doc.id
              });
            }
          });
          
          // Sort by compatibility (highest first)
          potentialMatches.sort((a, b) => b.compatibilityScore - a.compatibilityScore);
          
          resolve(potentialMatches);
        } catch (error) {
          console.error("Error in matching:", error);
          resolve([]);
        }
      });
    }

    function calculateCompatibility(user, event) {
      let score = 0;
      
      // Skill level match (exact match = highest score)
      if (user.skillLevel === event.skillLevel) score += 50;
      
      // Preferred times match
      if (user.preferredTimes.some(t => event.time.includes(t.split(" ")[1]))) {
        score += 30;
      }
      
      // Playing frequency (more frequent = higher score)
      if (user.playingFrequency === "Daily") score += 20;
      else if (user.playingFrequency === "Weekly") score += 15;
      else score += 5;
      
      return Math.min(100, score); // Cap at 100%
    }

    // Modified createEvent function with AI matching
    async function createEvent() {
      if (!currentUser) {
        alert("Please log in to create an event");
        return;
      }

      const eventData = {
        sport: $('#eventSportType').val(),
        date: $('#eventDate').val(),
        time: $('#eventTime').val(),
        duration: parseFloat($('#eventDuration').val()),
        skillLevel: $('#eventSkillLevel').val(),
        playersNeeded: parseInt($('#eventPlayersNeeded').val()),
        facility: $('#eventFacility').val() || null,
        description: $('#eventDescription').val() || '',
        invitedPlayers: $('#eventPrivate').is(':checked') ? $('#inviteFriends').val() : [],
        organizerId: currentUser.uid,
        organizerName: currentUser.displayName || currentUser.email || "Guest",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        participants: null,
        status: 'active'
      };

      try {
        // Show loading state
        $('#createEventBtn').html('<span class="spinner-border spinner-border-sm" role="status"></span> Finding matches...');
        
        // Find matching players using AI
        const matchedPlayers = await findMatchingPlayers(eventData);
        
        if (matchedPlayers.length === 0) {
          alert("No matching players found. You can still create the event and invite friends manually.");
        }
        
        // Show match details before creating event
        showMatchDetails(matchedPlayers, eventData);
        
      } catch (error) {
        console.error("Error creating event:", error);
        alert("Error creating event. Please try again.");
      } finally {
        $('#createEventBtn').html('<i class="bi bi-calendar-event"></i> Create Event');
      }
    }

    function showMatchDetails(matchedPlayers, eventData) {
      const playersNeeded = parseInt($('#eventPlayersNeeded').val());
      const playersToShow = matchedPlayers.slice(0, playersNeeded - 1);
      
      let content = `
        <h5>Event Details</h5>
        <div class="mb-3 p-3 bg-light rounded">
          <p><strong>Sport:</strong> ${capitalizeFirstLetter(eventData.sport)}</p>
          <p><strong>When:</strong> ${eventData.date} at ${formatTime(eventData.time)}</p>
          <p><strong>Skill Level:</strong> <span class="${getSkillLevelClass(eventData.skillLevel)}">
            ${capitalizeFirstLetter(eventData.skillLevel)}
          </span></p>
        </div>
        
        <h5 class="mt-4">AI Matched Players (${playersToShow.length})</h5>
        <p>Our system found these players that match your event criteria:</p>
      `;
      
      if (playersToShow.length > 0) {
        content += `<div class="row g-3 mt-2">`;
        
        playersToShow.forEach(player => {
          content += `
            <div class="col-md-6">
              <div class="card match-card h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <img src="${player.photoURL || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_640.png'}" 
                         class="rounded-circle me-3" width="50" height="50">
                    <div>
                      <h6 class="mb-0">${player.name}</h6>
                      <small class="text-muted">${player.email}</small>
                    </div>
                  </div>
                  
                  <div class="mt-3">
                    <div class="d-flex justify-content-between">
                      <small>Compatibility</small>
                      <small>${player.compatibilityScore}%</small>
                    </div>
                    <div class="compatibility-meter">
                      <div class="compatibility-fill" style="width: ${player.compatibilityScore}%"></div>
                    </div>
                  </div>
                  
                  <div class="row mt-2">
                    <div class="col-6">
                      <small><i class="bi bi-person-badge"></i> ${capitalizeFirstLetter(player.skillLevel)}</small>
                    </div>
                    <div class="col-6">
                      <small><i class="bi bi-clock"></i> ${player.preferredTimes.join(', ')}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        content += `</div>`;
      } else {
        content += `
          <div class="alert alert-info">
            No matching players found. You can still create the event and invite friends manually.
          </div>
        `;
      }
      
      content += `
        <div class="mt-4">
          <button class="btn btn-primary" id="confirmEventWithMatches">
            Confirm Event with These Matches
          </button>
          <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>
      `;
      
      $('#matchResultsContent').html(content);
      $('#matchDetailsModal').modal('show');
      
      // Handle confirmation
      $('#confirmEventWithMatches').click(async () => {
        $('#matchDetailsModal').modal('hide');
        await finalizeEventCreation(eventData, playersToShow);
      });
    }

    async function finalizeEventCreation(eventData, matchedPlayers) {
      try {
        // Limit to the number of players needed (minus 1 for organizer)
        const playersToInvite = matchedPlayers.slice(0, eventData.playersNeeded - 1);
        
        // Add to event data
        eventData.matchedPlayers = playersToInvite.map(p => p.id);
        eventData.pendingConfirmations = playersToInvite.map(p => p.id);
        
        // Save to Firestore
        const eventRef = await db.collection('events').add(eventData);
        eventData.id = eventRef.id;
        
        // Send notifications
        await sendEventNotifications(playersToInvite, eventData);
        
        // Show confirmation
        showEventConfirmation(eventData, playersToInvite);
        
      } catch (error) {
        console.error("Error finalizing event:", error);
        alert("Error creating event. Please try again.");
      }
    }

    async function sendEventNotifications(players, eventData) {
      try {
        const responses = await Promise.all(
          players.map(player => {
            return fetch('https://nste-email-api.onrender.com/send-event-invite', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: player.name,
                email: player.email,
                eventName: `${eventData.sport} Event`,
                date: eventData.date,
                time: eventData.time,
                organizer: eventData.organizerName,
                eventId: eventData.id
              })
            });
          })
        );
        
        console.log('Notifications sent:', responses);
      } catch (error) {
        console.error('Error sending notifications:', error);
      }
    }

    function showEventConfirmation(eventData, matchedPlayers) {
      const playerList = matchedPlayers.map(p => 
        `<li>${p.name} (${p.email}) - Compatibility: ${p.compatibilityScore}%</li>`
      ).join('');
      
      $('#eventDetails').html(`
        <div class="mb-2"><strong>Event:</strong> ${capitalizeFirstLetter(eventData.sport)} Session</div>
        <div class="mb-2"><strong>Date:</strong> ${eventData.date} at ${formatTime(eventData.time)}</div>
        <div class="mb-2"><strong>Matched Players:</strong></div>
        <ul>${playerList}</ul>
        ${eventData.description ? `
        <div class="mb-2"><strong>Description:</strong> ${eventData.description}</div>
        ` : ''}
      `);
      
      $('#eventConfirmModal').modal('show');
      $('#eventForm')[0].reset();
      $('#inviteFriendsContainer').hide();
    }

    async function loadFacilities() {
      try {
        const locationFilter = $('#locationSearch').val().toLowerCase();
        const nameFilter = $('#facilityNameSearch').val().toLowerCase();
        
        const snapshot = await db.collection('facilities')
          .where('type', '==', currentSport)
          .get();
        
        $('#facilityList').empty();
        $('#loading').hide();
        
        if (snapshot.empty) {
          $('#facilityList').html(`<div class="alert alert-info">No ${currentSport} courts available at the moment</div>`);
          return;
        }

        facilitiesData = [];
        snapshot.forEach(doc => {
          const facility = { id: doc.id, ...doc.data() };
          facilitiesData.push(facility);
        });

        // Apply filters
        let filteredFacilities = facilitiesData;
        if (locationFilter) {
          filteredFacilities = filteredFacilities.filter(f => 
            f.location && f.location.toLowerCase().includes(locationFilter));
        }
        if (nameFilter) {
          filteredFacilities = filteredFacilities.filter(f => 
            f.name && f.name.toLowerCase().includes(nameFilter));
        }

        if (filteredFacilities.length === 0) {
          $('#facilityList').html('<div class="alert alert-info">No facilities match your search criteria</div>');
          return;
        }

        filteredFacilities.forEach(facility => {
          const promoBadge = facility.promotion ? 
            `<span class="badge bg-danger promo-badge">${facility.promotion}</span>` : '';
            
          $('#facilityList').append(`
            <div class="col">
              <div class="card facility-card h-100">
                ${promoBadge}
                <img src="${facility.image || getDefaultSportImage(currentSport)}" 
                     class="card-img-top court-image" alt="${facility.name}">
                <div class="card-body">
                  <h5 class="card-title">${facility.name}</h5>
                  <p class="card-text">${facility.description || `${capitalizeFirstLetter(currentSport)} court`}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">RM${facility.price || '0'}/hour</span>
                    <small class="text-muted">${facility.location || ''}</small>
                  </div>
                </div>
                <div class="card-footer bg-transparent">
                  <button class="btn btn-primary w-100 book-btn" 
                          data-facility-id="${facility.id}"
                          data-facility-name="${facility.name}">
                    <i class="bi bi-calendar-plus"></i> Book Now
                  </button>
                </div>
              </div>
            </div>
          `);
        });

        $('.book-btn').click(function() {
          const facilityId = $(this).data('facility-id');
          const facilityName = $(this).data('facility-name');
          
          db.collection('facilities').doc(facilityId).get()
            .then(doc => {
              selectedFacility = { id: facilityId, ...doc.data() };
              $('#facilityNameDisplay').text(facilityName);
              
              // Show promotion if available
              if (selectedFacility.promotion) {
                $('#promoDetails').removeClass('d-none').html(`
                  <i class="bi bi-megaphone"></i> <strong>Special Promotion:</strong> ${selectedFacility.promotion}
                `);
              } else {
                $('#promoDetails').addClass('d-none');
              }
              
              $('#facilityList').hide();
              $('#calendarSection').show();
              $('#eventsSection').hide();
              $('#evoCalendar').evoCalendar('addCalendarEvent', []);
            })
            .catch(error => {
              console.error("Error loading facility:", error);
              alert("Error loading court details. Please try again.");
            });
        });
      } catch (error) {
        console.error("Error loading facilities:", error);
        $('#facilityList').html('<div class="alert alert-danger">Error loading courts. Please try again.</div>');
        $('#loading').hide();
      }
    }

    function getDefaultSportImage(sport) {
      const images = {
        tennis: 'https://images.unsplash.com/photo-1554068865-24cecd4e34b8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80',
        badminton: 'https://images.unsplash.com/photo-1593352216891-b5bfa7b5ba33?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80',
        squash: 'https://images.unsplash.com/photo-1600185365483-26d7a4cc7519?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1025&q=80',
        basketball: 'https://images.unsplash.com/photo-1546519638-68e109498ffc?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1490&q=80'
      };
      return images[sport] || images.tennis;
    }

    async function loadBookingsForFacility() {
      try {
        const snapshot = await db.collection('bookings')
          .where('date', '==', selectedDate)
          .where('facilityId', '==', selectedFacility.id)
          .get();
        
        const bookings = {};
        selectedFacility.slots.forEach(slot => {
          bookings[slot] = false;
        });

        snapshot.forEach(doc => {
          const slot = doc.data().slot;
          bookings[slot] = true;
        });

        renderSlotButtons(bookings);
        $('#selectedFacilityText').text(selectedFacility.name);
        $('#selectedDateText').text(selectedDate);
        $('#slotModal').modal('show');
      } catch (error) {
        console.error("Error loading bookings:", error);
        alert("Error loading available slots. Please try again.");
      }
    }

    function renderSlotButtons(bookings) {
      $('#slotButtons').empty();
      
      selectedFacility.slots.forEach(slot => {
        const isBooked = bookings[slot];
        const btn = $(`
          <button class="btn ${isBooked ? 'btn-secondary' : 'btn-primary'} slot-btn" 
                  ${isBooked ? 'disabled' : ''}>
            ${slot}
            ${isBooked ? '<br><small>Booked</small>' : ''}
          </button>
        `);
        
        if (!isBooked) {
          btn.click(() => {
            selectedSlot = slot;
            $('#slotModal').modal('hide');
            showSnacksSelection();
          });
        }
        
        $('#slotButtons').append(btn);
      });
    }

    function showSnacksSelection() {
      // Render snacks list
      $('#snacksList').empty();
      snacksData.forEach(snack => {
        $('#snacksList').append(`
          <div class="col">
            <div class="card h-100 snack-item">
              <img src="${snack.image}" class="card-img-top" style="height: 120px; object-fit: cover;">
              <div class="card-body">
                <h5 class="card-title">${snack.name}</h5>
                <p class="card-text">RM${snack.price.toFixed(2)}</p>
                <button class="btn btn-sm btn-outline-primary w-100 add-snack-btn" data-id="${snack.id}">
                  Add to Order
                </button>
              </div>
            </div>
          </div>
        `);
      });

      // Initialize selected snacks display
      updateSelectedSnacksDisplay();

      // Add snack button handler
      $('.add-snack-btn').click(function() {
        const snackId = parseInt($(this).data('id'));
        const snack = snacksData.find(s => s.id === snackId);
        
        const existingIndex = selectedSnacks.findIndex(s => s.id === snackId);
        if (existingIndex >= 0) {
          selectedSnacks[existingIndex].quantity++;
        } else {
          selectedSnacks.push({
            id: snack.id,
            name: snack.name,
            price: snack.price,
            quantity: 1
          });
        }
        
        updateSelectedSnacksDisplay();
      });

      // Remove snack handler
      $(document).on('click', '.remove-snack-btn', function() {
        const snackId = parseInt($(this).data('id'));
        selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);
        updateSelectedSnacksDisplay();
      });

      $('#snacksModal').modal('show');
    }

    function updateSelectedSnacksDisplay() {
      $('#selectedSnacks').empty();
      let total = 0;
      
      if (selectedSnacks.length === 0) {
        $('#selectedSnacks').html('<p class="text-muted">No snacks selected</p>');
      } else {
        selectedSnacks.forEach(snack => {
          $('#selectedSnacks').append(`
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>${snack.name} (${snack.quantity})</span>
              <div>
                <span class="me-2">RM${(snack.price * snack.quantity).toFixed(2)}</span>
                <button class="btn btn-sm btn-outline-danger remove-snack-btn" data-id="${snack.id}">
                  ×
                </button>
              </div>
            </div>
          `);
          total += snack.price * snack.quantity;
        });
      }
      
      $('#snacksTotal').text(total.toFixed(2));
    }

    function showCoachesSelection() {
      // Render coaches list
      $('#coachesList').empty();
      coachesData.forEach(coach => {
        $('#coachesList').append(`
          <div class="col">
            <div class="card coach-item">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="${coach.image}" class="img-fluid rounded-start h-100" style="object-fit: cover;">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">${coach.name}</h5>
                    <p class="card-text"><small class="text-muted">${coach.experience} experience</small></p>
                    <p class="card-text"><i class="bi bi-star-fill text-warning"></i> ${coach.rating}</p>
                    <p class="card-text">RM${coach.price}/session</p>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="coachOption" 
                             id="coach-${coach.id}" value="${coach.id}">
                      <label class="form-check-label" for="coach-${coach.id}">
                        Select Coach
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `);
      });

      $('#coachModal').modal('show');
    }

    async function completeBooking() {
      if (!currentUser) {
        alert("Please log in to complete booking");
        return;
      }

      const bookingData = {
        date: selectedDate,
        slot: selectedSlot,
        facilityId: selectedFacility.id,
        facilityName: selectedFacility.name,
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email || "Guest",
        email: currentUser.email || "no-email@example.com",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        price: selectedFacility.price,
        status: 'confirmed',
        type: 'tennis',
        addons: {
          snacks: selectedSnacks,
          coach: selectedCoach ? {
            id: selectedCoach.id,
            name: selectedCoach.name,
            price: selectedCoach.price
          } : null
        },
        totalAmount: calculateTotal(),
        friendId: bookingWithFriend ? bookingWithFriend.id : null,
        friendName: bookingWithFriend ? bookingWithFriend.name : null
      };

      try {
        await db.collection('bookings').add(bookingData);
        
        // Show confirmation
        $('#bookingDetails').html(`
          <div class="mb-2"><strong>Court:</strong> ${selectedFacility.name}</div>
          <div class="mb-2"><strong>Date:</strong> ${selectedDate}</div>
          <div class="mb-2"><strong>Time:</strong> ${selectedSlot}</div>
          ${bookingWithFriend ? `
          <div class="mb-2"><strong>Playing with:</strong> ${bookingWithFriend.name}</div>
          ` : ''}
          <div class="mb-2"><strong>Base Price:</strong> RM${selectedFacility.price.toFixed(2)}</div>
          ${selectedSnacks.length > 0 ? `
          <div class="mb-2"><strong>Snacks:</strong> 
            ${selectedSnacks.map(s => `${s.name} (${s.quantity})`).join(', ')}
          </div>
          ` : ''}
          ${selectedCoach ? `
          <div class="mb-2"><strong>Coach:</strong> ${selectedCoach.name}</div>
          ` : ''}
          <div class="mt-3 pt-2 border-top"><strong>Total Amount:</strong> RM${bookingData.totalAmount.toFixed(2)}</div>
        `);
        $('#confirmModal').modal('show');
        
        // Reset selections
        selectedFacility = null;
        selectedDate = null;
        selectedSlot = null;
        selectedSnacks = [];
        selectedCoach = null;
        bookingWithFriend = null;
        
        // Return to facility list
        $('#calendarSection').hide();
        $('#facilityList').show();
        $('#friendNotice').addClass('d-none');
      } catch (error) {
        console.error("Error saving booking:", error);
        alert("Error completing booking. Please try again.");
      }
    }

    function calculateTotal() {
      let total = selectedFacility.price;
      
      // Add snacks total
      selectedSnacks.forEach(snack => {
        total += snack.price * snack.quantity;
      });
      
      // Add coach price if selected
      if (selectedCoach) {
        total += selectedCoach.price;
      }
      
      return total;
    }
  </script>
</body>
</html>